---
title: "The Truth Trajectory: Main Analysis"
author: "Emma L. Henderson, Daniel J. Simons, and Dale J. Barr"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    code_folding: hide
    df_print: paged
params:
  subdir: NULL
  inferential: FALSE
  recipe: FALSE
---

<style>
div.warn { background-color:#ff8888; border-radius: 5px; padding: 20px; }
div.note { background-color:#e6f0ff; border-radius: 5px; padding: 20px; }
</style>

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

## shortcut for pretty printing for integers
.pi <- function(x) prettyNum(x, big.mark=',')

## make sure truthiness is installed
if (!requireNamespace("truthiness")) {
  stop("You must install the 'truthiness' package to run this analysis. \n",
       "devtools::install_github('dalejbarr/truthiness')")
}

if (is.null(params$subdir)) {
  stop("you need to specify the subdirectory containing the anonymized data")
}

if (!dir.exists(params$subdir)) {
  stop("subdirectory '", params$subdir, "' does not exist")
}

## function to check whether we are working with real or simulated data
## and spit out a warning box
warn <- function() {
  if (truthiness::check_fake(params$subdir)) {
    paste("\n<div class=\"warn\">",
          "*WARNING! Results in this document are based on **simulated** data*.",
          "This document will be re-compiled and results will be updated after data collection.\n",
          "</div>\n", sep = "\n")
  }
}
```

```{r reproduction-recipe, echo = FALSE, results = 'asis'}
if (params$recipe) {
  cat(readLines(system.file("repr_instr.Rmd", package = "truthiness",
                            mustwork = TRUE)), sep = "\n")
}
```

## Import and preprocess

```{r packages, message = FALSE}
## Load in the required add-on packages.

library("truthiness")
library("tidyverse")
```

Importing data from files in subdirectory ``r params$subdir``.

For information about the structure of the anonymized data files and stimulus materials, either run `truthiness::codebook()` in the R console, or download and view the file [codebook.html](https://osf.io/2gmds/) in the OSF repository for this project.

`r warn()`

```{r import}
sess <- read_csv(file.path(params$subdir, "ANON_sessions.csv"),
                 col_types = "cfccccllll") %>%
  mutate(list_id = fct_relevel(list_id,
                               levels(stimulus_conditions[["list_id"]])),
         gender = fct_relevel(gender,
                              c("Female", "Male",
                                "Gender Variant", "Not Reported")))

phase <- read_csv(file.path(params$subdir, "ANON_phases.csv"),
                  col_types = "cfill") %>%
  mutate(phase_id = fct_relevel(phase_id, as.character(1:4)))

interest <- read_csv(file.path(params$subdir, "ANON_interest.csv"),
                     col_types = "cfi") %>%
  mutate(stim_id = fct_relevel(stim_id,
                               levels(stimulus_conditions[["stim_id"]])))

ratings <- read_csv(file.path(params$subdir, "ANON_ratings.csv"),
                    col_types = "cffi") %>%
  mutate(phase_id = fct_relevel(phase_id, as.character(1:4)),
         stim_id = fct_relevel(stim_id,
                               levels(stimulus_conditions[["stim_id"]])))

n_item <- ratings %>% distinct(stim_id) %>% nrow()
```

## Pre-registered Exclusions

The anonymized files contain `r .pi(nrow(ratings))` truth ratings of
`r .pi(n_item)` statements from `r .pi(nrow(sess))` participants. Any
participants who did not provide consent for the entire study will
already have had their data removed during the pre-processing
stage. Also any phases of the study where a participant withheld
consent (despite consenting overall) will also have already been
removed before this stage.

### Participant-level exclusions

There were four main exclusion criteria for removing participants, applied in the following order:

1. Not being a (self-reported) native speaker of English;
2. Reporting having looked up answers in at least one phase of the study;
3. Flat lining; i.e., using only one response category across an entire phase of the study;
4. Failing to complete all phases in a reasonable amount of time (for Phase 1, between 3 and 40 minutes; for all other phases, between 1 and 30 minutes).

```{r remove-nonnative}
sess_native <- sess %>%
  filter(chk_native)

n_nonnative <- nrow(sess) - nrow(sess_native)

sess_nocheat <- sess_native %>%
  filter(chk_nocheat)

n_cheat <- nrow(sess_native) - nrow(sess_nocheat)

sess_noflat <- sess_nocheat %>%
  filter(chk_flatline)

n_flatline <- nrow(sess_nocheat) - nrow(sess_noflat)

sess_keep0 <- sess_noflat %>%
  filter(chk_dur_all)

n_dur_out_range <- nrow(sess_noflat) - nrow(sess_keep0)

n_total <- n_nonnative + n_cheat + n_flatline + n_dur_out_range
```

Applying these criteria resulted in the removal of:

* `r .pi(n_nonnative)` non-native English speaking participants;
* `r .pi(n_cheat)` participants who reported looking up answers;
* `r .pi(n_flatline)` participants who flat-lined in at least one phase; and
* `r .pi(n_dur_out_range)` participants who had at least one phase with completion times outside the acceptable range.

In total, the exclusion criteria resulted in the removal of 
`r .pi(n_total)` participants.

```{r exclude}
## remove truth ratings from excluded participants
ratings2 <- ratings %>%
  semi_join(sess_keep0, "ID")

## remove interest ratings while we're at it
interest2 <- interest %>%
  semi_join(sess_keep0, "ID")
```

Removing data from these 
`r .pi(n_total)`
participants resulted in the removal of 
`r .pi(nrow(ratings) - nrow(ratings2))` truth ratings.

### Phase-level exclusions

The only exclusion criterion applied at the phase-level was failure to complete all of the ratings in the phase.

```{r phase-finished}
phase_trim <- phase %>%
  semi_join(sess_keep0, "ID")

phase_keep <- phase_trim %>%
  filter(chk_finished)

n_incomplete <- nrow(phase_trim) - nrow(phase_keep)

## now remove the truth ratings
ratings_keep <- ratings2 %>%
  semi_join(phase_keep, c("ID", "phase_id")) 

## also remove the interest ratings
interest_keep <- interest2 %>%
  semi_join(phase_keep %>% filter(phase_id == "1"), "ID")
```

This criterion resulted in the removal of 
`r .pi(n_incomplete)` phases
(`r .pi(nrow(ratings2) - nrow(ratings_keep))` truth ratings).

## Descriptive statistics

`r warn()`

```{r kill-orphans}
## make sure there are no entries in sess_keep0 for subjects
## who have lost all of their phase data.
sess_keep <- semi_join(sess_keep0, ratings, "ID")

n_orphaned <- nrow(sess_keep0) - nrow(sess_keep)
```

```{r orph-txt, echo = FALSE, results = "asis"}
if (n_orphaned) {
  cat("The phase exclusions above combined with dropouts meant ",
      "that an additional ",
      n_orphaned,
      " participants were left with no ratings data.", sep = "")
}
```

Dropouts and the application of exclusion criteria left
`r .pi(nrow(sess_keep))` participants remaining for analysis, who
contributed a total of `r .pi(nrow(ratings_keep))` ratings.

### Exclusions by Phase and Gender

```{r gender-tbl}
included <- phase_keep %>%
  inner_join(sess_keep %>%
             select(ID, gender), "ID") %>%
  count(phase_id, gender, .drop = FALSE) %>%
  rename(n_analysed = n)

excluded <- anti_join(phase,
                      phase_keep, c("ID", "phase_id")) %>%
  inner_join(sess %>%
             select(ID, gender), "ID") %>%
  count(phase_id, gender, .drop = FALSE) %>%
  rename(n_excluded = n)

inner_join(excluded, included, c("phase_id", "gender")) %>%
  mutate(n_recruited = n_excluded + n_analysed) %>%
  select(phase_id, gender,
         n_recruited, n_excluded, n_analysed) %>%
  knitr::kable(caption = "Participants Recruited, Excluded, and Analysed, Separated by Experimental Phase and Gender")
```

### Means and standard deviations

```{r assign-cond}
## lookup which condition each rating belongs to
ratecond <- ratings %>%
  inner_join(sess_keep %>% select(ID, list_id), "ID") %>%
  inner_join(stimulus_conditions, c("list_id", "stim_id"))
```

First, let's collapse over interval and look at the means and SDs for repetition.

```{r rep-means-sd}
ratecond %>%
  group_by(repetition) %>%
  summarise(mean = round(mean(trating), 2),
            `standard deviation` = round(sd(trating), 2))
```

Now let's look at the repetition effects for each interval.

```{r cell-means-sd}
ratecond %>%
  group_by(repetition, interval) %>%
  summarise(mean = round(mean(trating), 2),
            sd = round(sd(trating), 2)) %>%
  ungroup() %>%
  pivot_wider(names_from = c(repetition),
              values_from = c(mean, sd)) %>%
  mutate(diff = round(mean_repeated - mean_new, 2)) %>%
  select(interval, mean_repeated, mean_new, diff, sd_repeated, sd_new)
```

**TODO**: make a figure showing subject and stimulus means

## Inferential statistics

```{r inferential, results='asis', echo = FALSE, eval = (!params$inferential)}
cat("<div class=\"note\">\n",
    "**NOTE**: Because the estimation of the cumulative logit mixed model ",
    " can take a long time (more than 24 hours) ",
    "inferential statistics are disabled by default. ",
    "To enable them, knit the source file ",
    "with the parameter `inferential` set to `TRUE`.\n",
    "</div>\n", sep = "")
```

```{r inf-main, results='asis', echo = FALSE, eval = (params$inferential)}
cat(warn(), "\n", sep = "")

cat("### Main effect\n* TODO\n")
```

```{r inf-int, results='asis', echo = FALSE, eval = (params$inferential)}
cat("### Interaction\n* TODO\n")
```

## Session information

```{r exit}
## before exiting, print out session info
sessionInfo()
```
