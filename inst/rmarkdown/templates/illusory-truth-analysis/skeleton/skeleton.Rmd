---
title: "The Truth Trajectory: Analysis"
author: Dale J. Barr and Emma Henderson
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document:
    toc: true
    code_folding: hide
    df_print: paged
params:
  inferential: FALSE
  subdir: NULL
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Instructions for reproducing these analyses

Note that to re-run this analysis you'll need to have an anonymized copy of the data available in a subdirectory of the working directory. If you don't have the data you can create simulated data, as described in the sections below.

You can re-run the analysis either with or without a software container that encapsulates all the software used in the project. Using the software container is the only method guaranteed to exactly match the results obtained by the authors. Instructions are provided below for both methods.

## Reproducing the analysis with the singularity software container

Make sure you have installed [Singularity version 3.5](https://sylabs.io/guides/3.5/user-guide/) and are at a command prompt in a directory containing the subdirectory with the anonymous data.

If you don't have a copy of the anonymized data available and want to test it out on a simulated version of data, the following command will make a dataset with 576 participants in the directory `fake_data`. 

```
singularity exec library://dalejbarr/talklab/illusory-truth \
    make fake_data
```

To re-run the full analysis, including the inferential statistics:

```
singularity exec library://dalejbarr/talklab/illusory-truth \ 
    make analysis SUBDIR=path-to-anonymized-data
```

where `path-to-anonymized-data` is replaced with the name of the subdirectory with the anonymous data (e.g., the `fake_data` directory you created above).

The inferential statistics can take *very long* to run. To re-run the analysis without the inferential statistics:

```
singularity exec library://dalejbarr/talklab/illusory-truth \ 
    make analysis_noinf SUBDIR=path-to-anonymized-data
```

If you want to access the master R Markdown script because, for instance, you want to edit or expand on it, the following command copies the script to the file `my_analysis.Rmd` in the working directory.

```
singularity exec library://dalejbarr/talklab/illusory-truth \
    make draft OUT=my_analysis.Rmd
```

You can then render the script using the container as follows:

```
singularity exec library://dalejbarr/talklab/illusory-truth \
    Rscript -e 'rmarkdown::render("my_analysis.Rmd", params = list(subdir = "path-to-anonymized-data", inferential = FALSE))'
```

altering `path-to-anonymized-data` and `inferential = FALSE` as required.

## Reproducing the analysis without the singularity software container

The [R Markdown](https://rmarkdown.rstudio.com/index.html) source document used to create this file is included with the [truthiness](https://github.com/dalejbarr/truthiness) package (`devtools::install_github("dalejbarr/truthiness")`) that accompanies this project.  The software versions required are shown at the end of this document. If any of your software does not match these versions, you are not guaranteed to get the exact same results as the authors.

If your only interest is in re-running the analysis, simply issue the following command within the R console.

```
truthiness::reproduce_analysis(path = "path-to-anonymized-data")
```

Replace `path-to-anonymized-data` with the name of the subdirectory containing the data. Inferential stats are not performed by default due to the long processing time required. To turn on the inferential stats, add the argument `inferential = TRUE`.

If you don't have a copy of the anonymized data available and want to test it out on a simulated version of data, install the [truthiness](https://github.com/dalejbarr/truthiness) package and use the following sequence of commands.

```
truthiness::simulate_resp_files(576, "fake_raw_data")
truthiness::preprocess("fake_raw_data", "fake_data")
```

This will create a directory `fake_data` with simulated data. See the package documentation (`?truthiness::simulate_resp_files`) for additional options.

### Accessing the master R Markdown script through RStudio

If you are using RStudio, simply go to the pull down menu 
`File -> New File... -> R Markdown...`, choose "From Template" in the left-hand options box and then choose "Illusory Truth Analysis" from the list of available templates.

Compile the R Markdown document to HTML using the 'Knit' button in RStudio. 

You can control where the process looks for the anonymized data by setting the value of `subdir` in the YAML header. You can also turn on inferential stats in the same manner. See the example of YAML values below.

```
params:
  inferential: TRUE
  subdir: "fake_preprocessed_data"

```

### Accessing the master R Markdown script Without RStudio

The following command accesses the R Markdown script without RStudio.

```
rmarkdown::draft("my_analysis.Rmd", "illusory-truth-analysis", "truthiness")
```

This command will create the file `my_analysis.Rmd` in the working directory, which can then be edited and compiled.

Render to HTML using the following command:

```
rmarkdown::render("my_analysis.Rmd")
```

You can control the location of the subdirectory with the data files as well as turn on inferential stats by editing the YAML as shown in the above section, or alternatively through the `params` argument, as in the below example.

```
rmarkdown::render("my_analysis.Rmd", 
                  params = list(subdir = "path-to-anonymized-data",
				                inferential = TRUE))
```

# Main analysis

## Import and preprocess


```{r packages, message = FALSE}
## Load in the required add-on packages.

## library("truthiness")
devtools::load_all("../../truthiness")
library("tidyverse")

## shortcut for pretty printing for integers
.pi <- function(x) prettyNum(x, big.mark=',')
```

```{r subdir, echo = FALSE}
subdir <-
  if (is.null(params$subdir)) {
    dirs <- grep("^anon-[0-9]{4}-[0-9]{2}-[0-9]{2}",
                 list.dirs(".", FALSE, recursive = FALSE), value = TRUE)
    if (length(dirs) == 0L) {
      stop("No data subdirectories found and params$subdir was NULL.\n",
           "       If you wish to create sample data, use:\n",
           "       truthiness::simulate_resp_files() and then\n",
           "       truthiness::preprocess().")
    }
    dirs[length(dirs)]
  } else {
    params$subdir
  }
```

Importing data from files in subdirectory ``r subdir``.

```{r import}
sess <- read_csv(file.path(subdir, "ANON_sessions.csv"),
                 col_types = "cfll") %>%
  mutate(list_id = fct_relevel(list_id,
                               levels(stimulus_conditions[["list_id"]])))

phase <- read_csv(file.path(subdir, "ANON_phases.csv"),
                  col_types = "cfill") %>%
  mutate(phase_id = fct_relevel(phase_id, as.character(1:4)))

interest <- read_csv(file.path(subdir, "ANON_interest.csv"),
                     col_types = "cfii") %>%
  mutate(stim_id = fct_relevel(stim_id,
                               levels(stimulus_conditions[["stim_id"]])))

ratings <- read_csv(file.path(subdir, "ANON_ratings.csv"),
                    col_types = "cffii") %>%
  mutate(phase_id = fct_relevel(phase_id, as.character(1:4)),
         stim_id = fct_relevel(stim_id,
                               levels(stimulus_conditions[["stim_id"]])))

n_item <- ratings %>% distinct(stim_id) %>% nrow()
```

## Pre-registered Exclusions

The anonymized files contain `r .pi(nrow(ratings))` truth ratings of
`r .pi(n_item)` statements from `r .pi(nrow(sess))` participants. Any
participants who did not provide consent for the entire study will
already have had their data removed during the pre-processing
stage. Also any phases of the study where a participant withheld
consent (despite consenting overall) will also have already been
removed before this stage.

### Participant-level exclusions

There were two main exclusion criteria for removing participants:

1. Not being a (self-reported) native speaker of English;
2. Reporting having looked up answers in at least one phase of the study.

```{r remove-nonnative}
sess_native <- sess %>%
  filter(chk_native)

n_nonnative <- nrow(sess) - nrow(sess_native)

sess_keep0 <- sess_native %>%
  filter(chk_nocheat)

n_noncomply <- nrow(sess_native) - nrow(sess_keep0)
```

Applying these two criteria resulted in the removal of 
`r .pi(n_nonnative)`
non-native English speaking participants and
`r if (n_nonnative > 0L) {"an additional"}`
`r .pi(n_noncomply)` participants who reported looking up answers.

```{r exclude}
## remove truth ratings from excluded participants
ratings2 <- ratings %>%
  semi_join(sess_keep0, "ID")

## remove interest ratings while we're at it
interest2 <- interest %>%
  semi_join(sess_keep0, "ID")
```

Removing data from these 
`r .pi(n_nonnative + n_noncomply)`
participants resulted in the removal of 
`r .pi(nrow(ratings) - nrow(ratings2))` truth ratings.

### Phase-level exclusions

There were two main exclusion criteria applying to the data from each
phase of the study:

1. Whether the participant completed all of the ratings in the phase;
2. Whether the participant completed the phase in a reasonable time, namely:
	* Between 3 and 40 minutes for Phase 1, and
	* Between 1 and 30 minutes for Phase 2, 3, and 4.

```{r phase-finished}
## criterion 1
phase_finished <- phase %>%
  filter(chk_finished)

n_incomplete <- nrow(phase) - nrow(phase_finished)

## criterion 2
phase_keep <- phase_finished %>%
  filter(chk_dur) 

n_duration <- nrow(phase_finished) - nrow(phase_keep)

## now remove the truth ratings
ratings_keep <- ratings2 %>%
  semi_join(phase_keep, c("ID", "phase_id")) 

## also remove the interest ratings
interest_keep <- interest2 %>%
  semi_join(phase_keep %>% filter(phase_id == "1"), "ID")
```

Applying these criteria resulted in the removal of 
`r .pi(n_incomplete)` incomplete phases and
`r .pi(n_duration)` additional phases that were not completed 
in a reasonable amount of time,
leading to the removal of 
`r .pi(nrow(ratings2) - nrow(ratings_keep))` truth ratings
associated with these phases.

## Descriptive statistics

```{r kill-orphans}
## make sure there are no entries in sess_keep0 for subjects
## who have lost all of their phase data.
sess_keep <- semi_join(sess_keep0, ratings, "ID")

n_orphaned <- nrow(sess_keep0) - nrow(sess_keep)
```

```{r orph-txt, echo = FALSE, results = "asis"}
if (n_orphaned) {
  cat("The phase exclusions above combined with dropouts meant ",
      "that an additional ",
      n_orphaned,
      " participants were left with no ratings data.", sep = "")
}
```

After all dropouts and exclusion criteria, there were 
`r .pi(nrow(sess_keep))` participants remaining for analysis, who
contributed a total of `r .pi(nrow(ratings_keep))` ratings.

### Dropouts

Below is a table of the number of subjects who completed each phase.

```{r dropouts}
## we need this quick lookup table
plookup <- stimulus_conditions %>%
  distinct(interval) %>%
  mutate(phase_id = factor(1:4))

phase_keep %>%
  inner_join(plookup, "phase_id") %>%
  distinct(ID, interval) %>%
  count(interval)
```

### Means and standard deviations

```{r assign-cond}
## lookup which condition each rating belongs to
ratecond <- ratings %>%
  inner_join(sess_keep %>% select(ID, list_id), "ID") %>%
  inner_join(stimulus_conditions, c("list_id", "stim_id"))
```

First, let's collapse over interval and look at the means and SDs for repetition.

```{r rep-means-sd}
ratecond %>%
  group_by(repetition) %>%
  summarise(mean = round(mean(trating), 2),
            `standard deviation` = round(sd(trating), 2))
```

Now let's look at the repetition effects for each interval.

```{r cell-means-sd}
ratecond %>%
  group_by(repetition, interval) %>%
  summarise(mean = round(mean(trating), 2),
            sd = round(sd(trating), 2)) %>%
  ungroup() %>%
  pivot_wider(names_from = c(repetition),
              values_from = c(mean, sd)) %>%
  mutate(diff = round(mean_repeated - mean_novel, 2)) %>%
  select(interval, mean_repeated, mean_novel, diff, sd_repeated, sd_novel)
```

## Inferential statistics

```{r inferential, results='asis', echo = FALSE}
if (!params$inferential) {
  cat("**NOTE**: Because the statistical procedures can take a long time, ",
      "they are disabled by default. ",
      "To enable them, knit the source file ",
      "with the parameter `inferential` set to `TRUE`.\n", sep = "")
}
```

```{r inf-main, results='asis', echo = FALSE}
if (params$inferential) {cat("### Main effect\n* TODO\n")}
```

```{r inf-int, results='asis', echo = FALSE}
if (params$inferential) {cat("### Interaction\n* TODO\n")}
```

## Session information

```{r exit}
## before exiting, print out session info
sessionInfo()
```
